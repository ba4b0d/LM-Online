<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayaCRM - پنل مدیریت</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .main-content {
            transition: margin-right 0.3s ease-in-out;
        }
        .sidebar {
            transition: width 0.3s ease-in-out;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            color: #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            margin-bottom: 0.5rem;
            text-decoration: none;
        }
        .sidebar-link:hover {
            background-color: #334155; /* slate-700 */
            color: #ffffff;
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .sidebar-link i {
            margin-left: 0.75rem;
            width: 20px;
            text-align: center;
        }
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            animation: zoomIn 0.3s;
            position: relative;
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .close-button {
            color: #9ca3af;
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus {
            color: #1f2937;
        }
        /* Modal Table styles */
        .modal-table-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .modal-table th, .modal-table td {
            padding: 0.75rem 1.5rem;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-table th {
            background-color: #f9fafb;
            font-weight: 600;
            font-size: 0.75rem;
            color: #4b5563;
        }
        .modal-table tr:hover {
            background-color: #f3f4f6;
            cursor: pointer;
        }
        #modal-letter-content {
            white-space: pre-wrap;
            text-align: right;
            line-height: 1.8;
            font-size: 1rem;
            color: #333;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            margin-bottom: 1.5rem;
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <aside class="sidebar bg-gray-800 text-white w-64 min-h-screen p-4 fixed flex flex-col">
        <div class="flex items-center mb-8">
            <i class="fas fa-rocket text-3xl text-indigo-400"></i>
            <h1 class="text-2xl font-bold ml-3 mr-2">RayaCRM</h1>
        </div>
        <nav class="flex-grow">
            <a href="#" class="sidebar-link active" data-tab="dashboard">
                <i class="fas fa-home"></i>
                <span>داشبورد</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="letter">
                <i class="fas fa-file-signature"></i>
                <span>تولید نامه</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="archive">
                <i class="fas fa-archive"></i>
                <span>آرشیو نامه‌ها</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="crm">
                <i class="fas fa-users"></i>
                <span>مدیریت مشتریان</span>
            </a>
            <a href="#" class="sidebar-link" data-tab="settings">
                <i class="fas fa-cog"></i>
                <span>تنظیمات</span>
            </a>
        </nav>
        <div class="mt-auto">
             <div class="text-center text-gray-400 text-sm mb-4">
                <p id="sidebar-user-email" class="font-semibold"></p>
                <p id="sidebar-company-name"></p>
            </div>
            <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-200 flex items-center justify-center">
                <i class="fas fa-sign-out-alt ml-2"></i>
                <span>خروج</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 mr-64 p-8">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page-content active">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">داشبورد</h2>
            <p class="text-gray-600 mb-8 text-lg">به سیستم مدیریت نامه‌نگاری و CRM خوش آمدید.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                    <div class="flex items-center">
                        <div class="p-4 bg-indigo-100 rounded-full">
                            <i class="fas fa-building text-2xl text-indigo-600"></i>
                        </div>
                        <div class="mr-4">
                            <p class="text-gray-500">شرکت</p>
                            <p id="dashboard-company-name" class="text-2xl font-bold text-gray-800"></p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                    <div class="flex items-center">
                        <div class="p-4 bg-green-100 rounded-full">
                            <i class="fas fa-envelope text-2xl text-green-600"></i>
                        </div>
                        <div class="mr-4">
                            <p class="text-gray-500">ایمیل شما</p>
                            <p id="dashboard-user-email" class="text-xl font-bold text-gray-800"></p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                    <div class="flex items-center">
                        <div class="p-4 bg-yellow-100 rounded-full">
                            <i class="fas fa-user-shield text-2xl text-yellow-600"></i>
                        </div>
                        <div class="mr-4">
                            <p class="text-gray-500">نقش کاربری</p>
                            <p id="dashboard-user-role" class="text-2xl font-bold text-gray-800"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Letter Generation Page -->
        <div id="letter" class="page-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">تولید نامه جدید</h2>
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="org-select" class="block text-gray-700 text-sm font-bold mb-2">سازمان:</label>
                        <div class="flex items-center">
                            <input type="text" id="org-select" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="سازمان انتخاب شده" readonly>
                            <button id="select-org-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">انتخاب</button>
                        </div>
                        <input type="hidden" id="selected-org-id">
                    </div>
                    <div>
                        <label for="contact-select" class="block text-gray-700 text-sm font-bold mb-2">مخاطب:</label>
                        <div class="flex items-center">
                            <input type="text" id="contact-select" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="مخاطب انتخاب شده" readonly>
                            <button id="select-contact-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">انتخاب</button>
                        </div>
                        <input type="hidden" id="selected-contact-id">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="letter-type" class="block text-gray-700 text-sm font-bold mb-2">نوع نامه:</label>
                        <select id="letter-type" class="shadow-sm border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="GEN">عمومی</option>
                            <option value="FIN">مالی</option>
                            <option value="HR">منابع انسانی</option>
                        </select>
                    </div>
                     <div>
                        <label for="subject" class="block text-gray-700 text-sm font-bold mb-2">موضوع نامه:</label>
                        <input type="text" id="subject" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="موضوع نامه را وارد کنید">
                    </div>
                </div>
                <div class="mb-6">
                    <label for="body" class="block text-gray-700 text-sm font-bold mb-2">متن نامه:</label>
                    <textarea id="body" rows="10" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="متن اصلی نامه را اینجا وارد کنید"></textarea>
                </div>
                <button id="generate-letter-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 text-lg">
                    <i class="fas fa-check-circle ml-2"></i>
                    تولید و پیش‌نمایش نامه
                </button>
            </div>
        </div>
        
        <!-- Archive Page -->
        <div id="archive" class="page-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">آرشیو نامه‌ها</h2>
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="mb-4 flex items-center">
                    <input type="text" id="archive-search" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="جستجو بر اساس کد، موضوع، سازمان یا مخاطب">
                    <button id="archive-search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">کد نامه</th>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع</th>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاریخ</th>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">موضوع</th>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">سازمان</th>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">مخاطب</th>
                                <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="archive-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CRM Page -->
        <div id="crm" class="page-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">مدیریت مشتریان و مخاطبین</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Organizations Section -->
                <div class="bg-white p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">سازمان‌ها</h3>
                    <div class="mb-4 flex items-center">
                        <input type="text" id="org-crm-search" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="جستجوی سازمان">
                        <button id="org-crm-search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="flex justify-end space-x-2 rtl:space-x-reverse mb-4">
                        <button id="add-org-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"><i class="fas fa-plus ml-2"></i>افزودن</button>
                        <button id="edit-org-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"><i class="fas fa-edit ml-2"></i>ویرایش</button>
                        <button id="delete-org-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"><i class="fas fa-trash ml-2"></i>حذف</button>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نام سازمان</th>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تلفن</th>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ایمیل</th>
                                </tr>
                            </thead>
                            <tbody id="org-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Contacts Section -->
                <div class="bg-white p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">مخاطبین</h3>
                    <div class="mb-4 flex items-center">
                        <input type="text" id="contact-crm-search" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="جستجوی مخاطب">
                        <button id="contact-crm-search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="flex justify-end space-x-2 rtl:space-x-reverse mb-4">
                        <button id="add-contact-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"><i class="fas fa-plus ml-2"></i>افزودن</button>
                        <button id="edit-contact-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"><i class="fas fa-edit ml-2"></i>ویرایش</button>
                        <button id="delete-contact-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-200"><i class="fas fa-trash ml-2"></i>حذف</button>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نام</th>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">سازمان</th>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ایمیل</th>
                                </tr>
                            </thead>
                            <tbody id="contact-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">تنظیمات</h2>
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Company Info Section -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">اطلاعات شرکت</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="company-short-name" class="block text-gray-700 text-sm font-bold mb-2">نام اختصاری شرکت (کد نامه‌):</label>
                                <input type="text" id="company-short-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="مثال: NGRR">
                            </div>
                            <div>
                                <label for="company-full-name-footer" class="block text-gray-700 text-sm font-bold mb-2">نام کامل شرکت (در پابرگ نامه):</label>
                                <input type="text" id="company-full-name-footer" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="مثال: شرکت نوآوران گستر رایا رسانا">
                            </div>
                            <button id="save-settings-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                <i class="fas fa-save ml-2"></i>ذخیره اطلاعات شرکت
                            </button>
                        </div>
                    </div>
                    <!-- DOCX Template Upload Section -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">قالب سربرگ (Word)</h3>
                        <div class="flex items-center">
                            <input type="file" id="template-upload-input" accept=".docx" class="hidden">
                            <label for="template-upload-input" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-150 ease-in-out">
                                <i class="fas fa-upload ml-2"></i> انتخاب فایل
                            </label>
                            <span id="template-file-name" class="mr-3 text-gray-600">فایلی انتخاب نشده است.</span>
                        </div>
                        <button id="upload-template-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition duration-150 ease-in-out">
                            <i class="fas fa-cloud-upload-alt ml-2"></i> آپلود و ذخیره قالب
                        </button>
                        <div id="template-preview-container" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50" style="display: none;">
                            <p class="text-gray-600 text-sm mb-2">فایل الگوی فعلی:</p>
                            <p id="current-template-filename-display" class="text-md font-medium text-gray-800"></p>
                        </div>
                    </div>
                </div>
                <!-- User Management Section -->
                <div class="mt-10 pt-6 border-t">
                     <h3 class="text-xl font-semibold text-gray-800 mb-4">مدیریت کاربران سیستم</h3>
                     <div class="flex justify-between items-center">
                        <p class="text-gray-600">کاربران شرکت خود را اضافه، ویرایش یا حذف کنید.</p>
                        <button id="manage-users-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                            <i class="fas fa-users-cog ml-2"></i>نمایش پنل کاربران
                        </button>
                     </div>
                </div>
            </div>
             <!-- Manage Users Panel (initially hidden) -->
            <div id="manage-users-section" class="hidden mt-8 p-8 bg-white rounded-xl shadow-md">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">لیست کاربران</h3>
                <button id="add-user-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition mb-4">
                    <i class="fas fa-user-plus ml-2"></i> افزودن کاربر جدید
                </button>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full bg-white">
                         <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ایمیل</th>
                                <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نقش</th>
                                <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- All Modals will be placed here -->
    <div id="addOrgModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">افزودن سازمان جدید</h3><form id="add-org-form"><div class="mb-4"><label for="new-org-name" class="block text-gray-700 text-sm font-bold mb-2">نام سازمان:</label><input type="text" id="new-org-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="new-org-industry" class="block text-gray-700 text-sm font-bold mb-2">صنعت:</label><input type="text" id="new-org-industry" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="new-org-phone" class="block text-gray-700 text-sm font-bold mb-2">تلفن:</label><input type="text" id="new-org-phone" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="new-org-email" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label><input type="email" id="new-org-email" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="new-org-address" class="block text-gray-700 text-sm font-bold mb-2">آدرس:</label><input type="text" id="new-org-address" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-6"><label for="new-org-description" class="block text-gray-700 text-sm font-bold mb-2">توضیحات:</label><textarea id="new-org-description" rows="3" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></textarea></div><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">افزودن</button><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></form></div></div>
    <div id="editOrgModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">ویرایش سازمان</h3><form id="edit-org-form"><input type="hidden" id="edit-org-id"><div class="mb-4"><label for="edit-org-name" class="block text-gray-700 text-sm font-bold mb-2">نام سازمان:</label><input type="text" id="edit-org-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="edit-org-industry" class="block text-gray-700 text-sm font-bold mb-2">صنعت:</label><input type="text" id="edit-org-industry" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="edit-org-phone" class="block text-gray-700 text-sm font-bold mb-2">تلفن:</label><input type="text" id="edit-org-phone" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="edit-org-email" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label><input type="email" id="edit-org-email" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="edit-org-address" class="block text-gray-700 text-sm font-bold mb-2">آدرس:</label><input type="text" id="edit-org-address" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-6"><label for="edit-org-description" class="block text-gray-700 text-sm font-bold mb-2">توضیحات:</label><textarea id="edit-org-description" rows="3" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></textarea></div><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">ذخیره</button><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></form></div></div>
    <div id="addContactModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">افزودن مخاطب جدید</h3><form id="add-contact-form"><div class="mb-4"><label for="new-contact-first-name" class="block text-gray-700 text-sm font-bold mb-2">نام:</label><input type="text" id="new-contact-first-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="new-contact-last-name" class="block text-gray-700 text-sm font-bold mb-2">نام خانوادگی:</label><input type="text" id="new-contact-last-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="new-contact-title" class="block text-gray-700 text-sm font-bold mb-2">عنوان/سمت:</label><input type="text" id="new-contact-title" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="new-contact-org-id" class="block text-gray-700 text-sm font-bold mb-2">سازمان مرتبط:</label><select id="new-contact-org-id" class="shadow-sm border rounded-md w-full py-2 px-3 text-gray-700"></select></div><div class="mb-4"><label for="new-contact-phone" class="block text-gray-700 text-sm font-bold mb-2">تلفن:</label><input type="text" id="new-contact-phone" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="new-contact-email" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label><input type="email" id="new-contact-email" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-6"><label for="new-contact-notes" class="block text-gray-700 text-sm font-bold mb-2">یادداشت‌ها:</label><textarea id="new-contact-notes" rows="3" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></textarea></div><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">افزودن</button><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></form></div></div>
    <div id="editContactModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">ویرایش مخاطب</h3><form id="edit-contact-form"><input type="hidden" id="edit-contact-id"><div class="mb-4"><label for="edit-contact-first-name" class="block text-gray-700 text-sm font-bold mb-2">نام:</label><input type="text" id="edit-contact-first-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="edit-contact-last-name" class="block text-gray-700 text-sm font-bold mb-2">نام خانوادگی:</label><input type="text" id="edit-contact-last-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="edit-contact-title" class="block text-gray-700 text-sm font-bold mb-2">عنوان/سمت:</label><input type="text" id="edit-contact-title" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="edit-contact-org-id" class="block text-gray-700 text-sm font-bold mb-2">سازمان مرتبط:</label><select id="edit-contact-org-id" class="shadow-sm border rounded-md w-full py-2 px-3 text-gray-700"></select></div><div class="mb-4"><label for="edit-contact-phone" class="block text-gray-700 text-sm font-bold mb-2">تلفن:</label><input type="text" id="edit-contact-phone" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-4"><label for="edit-contact-email" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label><input type="email" id="edit-contact-email" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></div><div class="mb-6"><label for="edit-contact-notes" class="block text-gray-700 text-sm font-bold mb-2">یادداشت‌ها:</label><textarea id="edit-contact-notes" rows="3" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700"></textarea></div><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">ذخیره</button><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></form></div></div>
    <div id="addUserModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">افزودن کاربر جدید</h3><form id="add-user-form"><div class="mb-4"><label for="new-user-email" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label><input type="email" id="new-user-email" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="new-user-password" class="block text-gray-700 text-sm font-bold mb-2">رمز عبور:</label><input type="password" id="new-user-password" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="new-user-confirm-password" class="block text-gray-700 text-sm font-bold mb-2">تایید رمز:</label><input type="password" id="new-user-confirm-password" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="new-user-role" class="block text-gray-700 text-sm font-bold mb-2">نقش:</label><select id="new-user-role" class="shadow-sm border rounded-md w-full py-2 px-3 text-gray-700"><option value="user">کاربر عادی</option><option value="admin">ادمین</option></select></div><div class="mb-6"><label for="new-user-company-name" class="block text-gray-700 text-sm font-bold mb-2">نام شرکت:</label><input type="text" id="new-user-company-name" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 bg-gray-100" readonly></div><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">افزودن</button><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></form></div></div>
    <div id="editUserModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">ویرایش کاربر</h3><form id="edit-user-form"><input type="hidden" id="edit-user-id"><div class="mb-4"><label for="edit-user-email" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label><input type="email" id="edit-user-email" class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 bg-gray-100" readonly></div><div class="mb-4"><label for="edit-user-role" class="block text-gray-700 text-sm font-bold mb-2">نقش:</label><select id="edit-user-role" class="shadow-sm border rounded-md w-full py-2 px-3 text-gray-700"><option value="user">کاربر عادی</option><option value="admin">ادمین</option></select></div><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">ذخیره</button><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></form></div></div>
    <div id="selectOrgModal" class="modal"><div class="modal-content max-w-2xl"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">انتخاب سازمان</h3><div class="mb-4 flex items-center"><input type="text" id="select-org-search" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700" placeholder="جستجوی سازمان"><button id="select-org-search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md"><i class="fas fa-search"></i></button></div><div class="modal-table-container"><table class="min-w-full bg-white modal-table"><thead class="bg-gray-50"><tr><th class="py-3 px-6 text-right">نام سازمان</th><th class="py-3 px-6 text-right">صنعت</th></tr></thead><tbody id="select-org-table-body"></tbody></table></div><div class="flex justify-end mt-4"><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></div></div>
    <div id="selectContactModal" class="modal"><div class="modal-content max-w-2xl"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4">انتخاب مخاطب</h3><div class="mb-4 flex items-center"><input type="text" id="select-contact-search" class="shadow-sm appearance-none border rounded-r-md w-full py-2 px-3 text-gray-700" placeholder="جستجوی مخاطب"><button id="select-contact-search-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-l-md"><i class="fas fa-search"></i></button></div><div class="modal-table-container"><table class="min-w-full bg-white modal-table"><thead class="bg-gray-50"><tr><th class="py-3 px-6 text-right">نام</th><th class="py-3 px-6 text-right">نام خانوادگی</th><th class="py-3 px-6 text-right">سازمان</th></tr></thead><tbody id="select-contact-table-body"></tbody></table></div><div class="flex justify-end mt-4"><button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">لغو</button></div></div></div>
    <div id="letter-download-modal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">نامه تولید شد</h3><div id="modal-letter-content"><div id="letter-template-info" class="mb-4 text-center text-sm text-gray-500"></div><div id="letter-body-display"></div></div><div class="flex justify-center mt-6 space-x-4 flex-wrap gap-2"><button id="download-docx-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg"><i class="fas fa-file-word ml-2"></i>دانلود Word</button><button id="copy-letter-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg"><i class="fas fa-copy ml-2"></i>کپی متن</button><button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg"><i class="fas fa-file-pdf ml-2"></i>دانلود PDF</button></div></div></div>

    <!-- Status Bar -->
    <div id="status-bar" class="fixed bottom-0 left-0 mr-64 w-[calc(100%-16rem)] bg-white border-t border-gray-200 text-gray-600 text-sm py-2 px-6 text-right transition-all duration-300">
        آماده به کار
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api'; 
        
        let currentUser = {
            id: null,
            role: null,
            company_name: null,
            email: null,
            company_short_name: '',
            company_full_name_footer: '',
            letter_template_path: null
        };

        let selectedOrgIdInCrm = null;
        let selectedContactIdInCrm = null;
        let currentGeneratedLetterDownloadUrl = '';
        let currentGeneratedLetterCode = '';

        const showStatus = (message, isError = false) => {
            const statusBar = document.getElementById('status-bar');
            if (statusBar) {
                statusBar.textContent = message;
                statusBar.className = `fixed bottom-0 left-0 mr-64 w-[calc(100%-16rem)] border-t text-sm py-2 px-6 text-right transition-all duration-300 ${isError ? 'bg-red-100 text-red-800 border-red-200' : 'bg-white text-gray-600 border-gray-200'}`;
            }
        };

        function showCustomAlert(message) {
            const existingModal = document.getElementById('custom-alert-modal');
            if(existingModal) existingModal.remove();

            const modalHtml = `<div id="custom-alert-modal" class="modal" style="display:flex;"><div class="modal-content max-w-sm"><h3 class="text-xl font-semibold text-gray-800 mb-4">پیام</h3><p class="text-gray-700 mb-6">${message}</p><div class="flex justify-end"><button id="alert-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">باشه</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const customAlertModal = document.getElementById('custom-alert-modal');
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                customAlertModal.remove();
            });
        }

        function showCustomConfirm(message, callback) {
            const existingModal = document.getElementById('custom-confirm-modal');
            if(existingModal) existingModal.remove();

            const modalHtml = `<div id="custom-confirm-modal" class="modal" style="display:flex;"><div class="modal-content max-w-sm"><h3 class="text-xl font-semibold text-gray-800 mb-4">تایید</h3><p class="text-gray-700 mb-6">${message}</p><div class="flex justify-end space-x-2 rtl:space-x-reverse"><button id="confirm-yes-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">بله</button><button id="confirm-no-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">خیر</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const customConfirmModal = document.getElementById('custom-confirm-modal');
            document.getElementById('confirm-yes-btn').addEventListener('click', () => {
                customConfirmModal.remove();
                callback(true);
            });
            document.getElementById('confirm-no-btn').addEventListener('click', () => {
                customConfirmModal.remove();
                callback(false);
            });
        }

        function openModal(modalElement) {
            if(modalElement) modalElement.style.display = 'flex';
        }

        function closeModal(modalElement) {
            if(modalElement) modalElement.style.display = 'none';
            const forms = modalElement.querySelectorAll('form');
            forms.forEach(form => form.reset());
        }

        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
        });

        const applyUserPermissions = () => {
            const settingsLink = document.querySelector('.sidebar-link[data-tab="settings"]');
            if (settingsLink) {
                settingsLink.style.display = (currentUser.role === 'admin' || currentUser.role === 'superadmin') ? 'flex' : 'none';
            }
            const crmButtons = ['add-org-btn', 'edit-org-btn', 'delete-org-btn', 'add-contact-btn', 'edit-contact-btn', 'delete-contact-btn'];
            crmButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = (currentUser.role !== 'admin' && currentUser.role !== 'superadmin');
                    btn.classList.toggle('opacity-50', btn.disabled);
                    btn.classList.toggle('cursor-not-allowed', btn.disabled);
                }
            });
        };

        const activateTab = async (tabId) => {
            if (!currentUser.company_name) {
                showCustomAlert('لطفاً ابتدا وارد سیستم شوید.');
                window.location.href = '/';
                return;
            }

            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.page-content').forEach(content => content.classList.remove('active'));

            const targetLink = document.querySelector(`.sidebar-link[data-tab="${tabId}"]`);
            const targetContent = document.getElementById(tabId);

            if (targetLink && targetContent) {
                targetLink.classList.add('active');
                targetContent.classList.add('active');
                showStatus(`صفحه "${targetLink.textContent.trim()}" فعال شد.`);

                if (document.getElementById('manage-users-section').classList.contains('hidden') === false && tabId !== 'settings') {
                    document.getElementById('manage-users-section').classList.add('hidden');
                }
                
                if (tabId === 'crm') { await fetchOrganizations(); await fetchContacts(); }
                else if (tabId === 'archive') { await fetchLetters(); }
                else if (tabId === 'settings') { await fetchCompanySettings(); }
                else if (tabId === 'dashboard') {
                    document.getElementById('dashboard-company-name').textContent = currentUser.company_name || 'نامشخص';
                    document.getElementById('dashboard-user-email').textContent = currentUser.email || 'نامشخص';
                    document.getElementById('dashboard-user-role').textContent = currentUser.role || 'نامشخص';
                }
            }
        };
        
        const fetchCompanySettings = async () => {
            if (!currentUser.company_name) return;
            showStatus('در حال بارگذاری تنظیمات شرکت...');
            try {
                const response = await fetch(`${API_BASE_URL}/settings?company_name=${encodeURIComponent(currentUser.company_name)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const settings = await response.json();
                
                currentUser.company_short_name = settings.company_short_name || '';
                currentUser.company_full_name_footer = settings.company_full_name_footer || '';
                currentUser.letter_template_path = settings.letter_template_path || null;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                document.getElementById('company-short-name').value = currentUser.company_short_name || '';
                document.getElementById('company-full-name-footer').value = currentUser.company_full_name_footer || '';

                const templatePreviewContainer = document.getElementById('template-preview-container');
                const currentTemplateFilenameDisplay = document.getElementById('current-template-filename-display');
                if (currentUser.letter_template_path) {
                    const filename = currentUser.letter_template_path.split('/').pop().split('\\').pop();
                    currentTemplateFilenameDisplay.textContent = filename;
                    templatePreviewContainer.style.display = 'block';
                } else {
                    templatePreviewContainer.style.display = 'none';
                }
                showStatus('تنظیمات شرکت بارگذاری شد.');
            } catch (error) {
                showStatus(`خطا در بارگذاری تنظیمات شرکت: ${error.message}`, true);
                showCustomAlert(`خطا در بارگذاری تنظیمات شرکت: ${error.message}`);
            }
        };

        const fetchOrganizations = async (searchTerm = '') => {
            if (!currentUser.company_name) return;
            showStatus('در حال بارگذاری سازمان‌ها...');
            try {
                const response = await fetch(`${API_BASE_URL}/organizations?company_name=${encodeURIComponent(currentUser.company_name)}&search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const organizations = await response.json();
                populateOrganizationsTable(organizations);
                populateOrgSelectForContacts(organizations);
            } catch (error) {
                showStatus(`خطا در بارگذاری سازمان‌ها: ${error.message}`, true);
            }
        };

        const populateOrganizationsTable = (organizations) => {
            const orgTableBody = document.getElementById('org-table-body');
            orgTableBody.innerHTML = '';
            if (organizations.length === 0) {
                orgTableBody.innerHTML = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">هیچ سازمانی یافت نشد.</td></tr>`;
                return;
            }
            organizations.forEach(org => {
                const row = orgTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.dataset.id = org.id;
                row.innerHTML = `
                    <td class="py-4 px-6">${org.name}</td>
                    <td class="py-4 px-6">${org.phone || '---'}</td>
                    <td class="py-4 px-6">${org.email || '---'}</td>
                `;
                row.addEventListener('click', () => selectOrgRowInCrm(org.id));
            });
        };

        const selectOrgRowInCrm = (orgId) => {
            document.querySelectorAll('#org-table-body tr').forEach(row => {
                row.classList.remove('bg-indigo-100');
            });
            const selectedRow = document.querySelector(`#org-table-body tr[data-id="${orgId}"]`);
            if (selectedRow) {
                selectedRow.classList.add('bg-indigo-100');
                selectedOrgIdInCrm = orgId;
                fetchContacts('', orgId);
            }
        };

        const addOrganization = async (orgData) => {
            try {
                const response = await fetch(`${API_BASE_URL}/organizations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...orgData, company_name: currentUser.company_name }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                const newOrg = await response.json();
                showCustomAlert(`سازمان "${newOrg.name}" با موفقیت افزوده شد.`);
                fetchOrganizations();
                return true;
            } catch (error) {
                showCustomAlert(`خطا در افزودن سازمان: ${error.message}`);
                return false;
            }
        };

        const openEditOrganizationModal = async () => {
            if (!selectedOrgIdInCrm) {
                showCustomAlert('لطفاً یک سازمان را برای ویرایش انتخاب کنید.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/organizations/${selectedOrgIdInCrm}?company_name=${encodeURIComponent(currentUser.company_name)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const org = await response.json();
                document.getElementById('edit-org-id').value = org.id;
                document.getElementById('edit-org-name').value = org.name || '';
                document.getElementById('edit-org-industry').value = org.industry || '';
                document.getElementById('edit-org-phone').value = org.phone || '';
                document.getElementById('edit-org-email').value = org.email || '';
                document.getElementById('edit-org-address').value = org.address || '';
                document.getElementById('edit-org-description').value = org.description || '';
                openModal(document.getElementById('editOrgModal'));
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری اطلاعات سازمان: ${error.message}`);
            }
        };

        const editOrganization = async (orgData) => {
            try {
                const response = await fetch(`${API_BASE_URL}/organizations/${orgData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...orgData, company_name: currentUser.company_name }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                showCustomAlert(`سازمان با موفقیت ویرایش شد.`);
                fetchOrganizations();
                return true;
            } catch (error) {
                showCustomAlert(`خطا در ویرایش سازمان: ${error.message}`);
                return false;
            }
        };

        const deleteOrganization = () => {
            if (!selectedOrgIdInCrm) {
                showCustomAlert('لطفاً یک سازمان را برای حذف انتخاب کنید.');
                return;
            }
            showCustomConfirm('آیا مطمئن هستید که می‌خواهید این سازمان و تمام مخاطبین مرتبط با آن را حذف کنید؟', async (confirmed) => {
                if (confirmed) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/organizations/${selectedOrgIdInCrm}?company_name=${encodeURIComponent(currentUser.company_name)}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        showCustomAlert('سازمان با موفقیت حذف شد.');
                        selectedOrgIdInCrm = null;
                        fetchOrganizations();
                        fetchContacts();
                    } catch (error) {
                        showCustomAlert(`خطا در حذف سازمان: ${error.message}`);
                    }
                }
            });
        };

        const fetchContacts = async (searchTerm = '', organizationId = null) => {
            if (!currentUser.company_name) return;
            let url = `${API_BASE_URL}/contacts?company_name=${encodeURIComponent(currentUser.company_name)}&search=${encodeURIComponent(searchTerm)}`;
            if (organizationId) url += `&organization_id=${organizationId}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const contacts = await response.json();
                populateContactsTable(contacts);
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری مخاطبین: ${error.message}`);
            }
        };

        const populateContactsTable = (contacts) => {
            const contactTableBody = document.getElementById('contact-table-body');
            contactTableBody.innerHTML = '';
            if (contacts.length === 0) {
                contactTableBody.innerHTML = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">هیچ مخاطبی یافت نشد.</td></tr>`;
                return;
            }
            contacts.forEach(contact => {
                const row = contactTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.dataset.id = contact.id;
                row.innerHTML = `
                    <td class="py-4 px-6">${contact.first_name} ${contact.last_name}</td>
                    <td class="py-4 px-6">${contact.organization_name || '---'}</td>
                    <td class="py-4 px-6">${contact.email || '---'}</td>
                `;
                row.addEventListener('click', () => selectContactRowInCrm(contact.id));
            });
        };

        const selectContactRowInCrm = (contactId) => {
            document.querySelectorAll('#contact-table-body tr').forEach(row => {
                row.classList.remove('bg-indigo-100');
            });
            const selectedRow = document.querySelector(`#contact-table-body tr[data-id="${contactId}"]`);
            if (selectedRow) {
                selectedRow.classList.add('bg-indigo-100');
                selectedContactIdInCrm = contactId;
            }
        };

        const populateOrgSelectForContacts = (organizations) => {
            const newContactOrgIdSelect = document.getElementById('new-contact-org-id');
            const editContactOrgIdSelect = document.getElementById('edit-contact-org-id');
            const selects = [newContactOrgIdSelect, editContactOrgIdSelect];
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">--- انتخاب سازمان ---</option>';
                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        select.appendChild(option);
                    });
                }
            });
        };

        const addContact = async (contactData) => {
            try {
                const response = await fetch(`${API_BASE_URL}/contacts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...contactData, company_name: currentUser.company_name }),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                showCustomAlert('مخاطب با موفقیت افزوده شد.');
                fetchContacts();
                return true;
            } catch (error) {
                showCustomAlert(`خطا در افزودن مخاطب: ${error.message}`);
                return false;
            }
        };

        const openEditContactModal = async () => {
            if (!selectedContactIdInCrm) {
                showCustomAlert('لطفاً یک مخاطب را برای ویرایش انتخاب کنید.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/contacts/${selectedContactIdInCrm}?company_name=${encodeURIComponent(currentUser.company_name)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const contact = await response.json();
                document.getElementById('edit-contact-id').value = contact.id;
                document.getElementById('edit-contact-first-name').value = contact.first_name || '';
                document.getElementById('edit-contact-last-name').value = contact.last_name || '';
                document.getElementById('edit-contact-title').value = contact.title || '';
                document.getElementById('edit-contact-phone').value = contact.phone || '';
                document.getElementById('edit-contact-email').value = contact.email || '';
                document.getElementById('edit-contact-notes').value = contact.notes || '';
                await fetchOrganizations();
                document.getElementById('edit-contact-org-id').value = contact.organization_id || '';
                openModal(document.getElementById('editContactModal'));
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری اطلاعات مخاطب: ${error.message}`);
            }
        };

        const editContact = async (contactData) => {
            try {
                const response = await fetch(`${API_BASE_URL}/contacts/${contactData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...contactData, company_name: currentUser.company_name }),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                showCustomAlert('مخاطب با موفقیت ویرایش شد.');
                fetchContacts();
                return true;
            } catch (error) {
                showCustomAlert(`خطا در ویرایش مخاطب: ${error.message}`);
                return false;
            }
        };

        const deleteContact = () => {
            if (!selectedContactIdInCrm) {
                showCustomAlert('لطفاً یک مخاطب را برای حذف انتخاب کنید.');
                return;
            }
            showCustomConfirm('آیا مطمئن هستید که می‌خواهید این مخاطب را حذف کنید؟', async (confirmed) => {
                if (confirmed) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/contacts/${selectedContactIdInCrm}?company_name=${encodeURIComponent(currentUser.company_name)}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) throw new Error((await response.json()).message);
                        showCustomAlert('مخاطب با موفقیت حذف شد.');
                        selectedContactIdInCrm = null;
                        fetchContacts();
                    } catch (error) {
                        showCustomAlert(`خطا در حذف مخاطب: ${error.message}`);
                    }
                }
            });
        };

        const fetchLetters = async (searchTerm = '') => {
            if (!currentUser.company_name) return;
            try {
                const response = await fetch(`${API_BASE_URL}/letters?company_name=${encodeURIComponent(currentUser.company_name)}&search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                populateArchiveTable(await response.json());
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری نامه‌ها: ${error.message}`);
            }
        };

        const populateArchiveTable = (letters) => {
            const archiveTableBody = document.getElementById('archive-table-body');
            archiveTableBody.innerHTML = '';
            if (letters.length === 0) {
                archiveTableBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">هیچ نامه‌ای یافت نشد.</td></tr>`;
                return;
            }
            letters.forEach(letter => {
                const row = archiveTableBody.insertRow();
                const contactName = (letter.first_name && letter.last_name) ? `${letter.first_name} ${letter.last_name}` : '---';
                row.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap">${letter.letter_code_persian}</td>
                    <td class="py-4 px-6">${letter.type}</td>
                    <td class="py-4 px-6">${letter.date_shamsi_persian}</td>
                    <td class="py-4 px-6">${letter.subject}</td>
                    <td class="py-4 px-6">${letter.organization_name || '---'}</td>
                    <td class="py-4 px-6">${contactName}</td>
                    <td class="py-4 px-6 text-center">
                        <button class="text-indigo-600 hover:text-indigo-900 font-medium" onclick="openLetterPreviewModal(${letter.id})">باز کردن</button>
                    </td>
                `;
            });
        };

        window.openLetterPreviewModal = async (letterId) => {
            try {
                const response = await fetch(`${API_BASE_URL}/letters/${letterId}?company_name=${encodeURIComponent(currentUser.company_name)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const letter = await response.json();
                
                currentGeneratedLetterCode = letter.letter_code_persian;
                currentGeneratedLetterDownloadUrl = `${API_BASE_URL}/letters/download/${letter.id}?company_name=${encodeURIComponent(currentUser.company_name)}`;

                document.getElementById('letter-body-display').textContent = letter.letter_content;
                openModal(document.getElementById('letter-download-modal'));
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری پیش‌نمایش نامه: ${error.message}`);
            }
        };

        const openOrgSelectionDialog = async (searchTerm = '') => {
            openModal(document.getElementById('selectOrgModal'));
            try {
                const response = await fetch(`${API_BASE_URL}/organizations?company_name=${encodeURIComponent(currentUser.company_name)}&search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                populateOrgSelectionTable(await response.json());
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری سازمان‌ها: ${error.message}`);
            }
        };

        const populateOrgSelectionTable = (organizations) => {
            const selectOrgTableBody = document.getElementById('select-org-table-body');
            selectOrgTableBody.innerHTML = '';
            if (organizations.length === 0) {
                selectOrgTableBody.innerHTML = `<tr><td colspan="2" class="py-3 px-6 text-center text-gray-500">هیچ سازمانی یافت نشد.</td></tr>`;
                return;
            }
            organizations.forEach(org => {
                const row = selectOrgTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.innerHTML = `<td class="py-4 px-6">${org.name}</td><td class="py-4 px-6">${org.industry || '---'}</td>`;
                row.addEventListener('click', () => selectOrgFromDialog(org.id, org.name));
            });
        };

        const selectOrgFromDialog = (orgId, orgName) => {
            document.getElementById('selected-org-id').value = orgId;
            document.getElementById('org-select').value = orgName;
            closeModal(document.getElementById('selectOrgModal'));
            document.getElementById('selected-contact-id').value = '';
            document.getElementById('contact-select').value = '';
        };

        const openContactSelectionDialog = async (searchTerm = '') => {
            openModal(document.getElementById('selectContactModal'));
            const selectedOrgId = document.getElementById('selected-org-id').value;
            let url = `${API_BASE_URL}/contacts?company_name=${encodeURIComponent(currentUser.company_name)}&search=${encodeURIComponent(searchTerm)}`;
            if (selectedOrgId) url += `&organization_id=${selectedOrgId}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                populateContactSelectionTable(await response.json());
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری مخاطبین: ${error.message}`);
            }
        };

        const populateContactSelectionTable = (contacts) => {
            const selectContactTableBody = document.getElementById('select-contact-table-body');
            selectContactTableBody.innerHTML = '';
            if (contacts.length === 0) {
                selectContactTableBody.innerHTML = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">هیچ مخاطبی یافت نشد.</td></tr>`;
                return;
            }
            contacts.forEach(contact => {
                const row = selectContactTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.innerHTML = `<td class="py-4 px-6">${contact.first_name}</td><td class="py-4 px-6">${contact.last_name}</td><td class="py-4 px-6">${contact.organization_name || '---'}</td>`;
                row.addEventListener('click', () => selectContactFromDialog(contact.id, `${contact.first_name} ${contact.last_name}`, contact.organization_id, contact.organization_name));
            });
        };

        const selectContactFromDialog = (contactId, contactFullName, orgId, orgName) => {
            document.getElementById('selected-contact-id').value = contactId;
            document.getElementById('contact-select').value = contactFullName;
            if (orgId && document.getElementById('selected-org-id').value != orgId) {
                document.getElementById('selected-org-id').value = orgId;
                document.getElementById('org-select').value = orgName;
            }
            closeModal(document.getElementById('selectContactModal'));
        };

        const generateLetter = async () => {
            if (!currentUser.letter_template_path) {
                showCustomAlert('لطفاً ابتدا یک فایل الگوی Word را در بخش تنظیمات آپلود کنید.');
                return;
            }
            const letterData = {
                company_name: currentUser.company_name,
                subject: document.getElementById('subject').value.trim(),
                body: document.getElementById('body').value.trim(),
                letter_type: document.getElementById('letter-type').value,
                organization_id: document.getElementById('selected-org-id').value ? parseInt(document.getElementById('selected-org-id').value) : null,
                contact_id: document.getElementById('selected-contact-id').value ? parseInt(document.getElementById('selected-contact-id').value) : null,
                user_id: currentUser.id
            };
            if (!letterData.subject || !letterData.body) {
                showCustomAlert('موضوع و متن نامه نمی‌توانند خالی باشند.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/letters/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(letterData),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                const result = await response.json();
                currentGeneratedLetterDownloadUrl = result.download_url;
                currentGeneratedLetterCode = result.letter_code;
                document.getElementById('letter-body-display').textContent = result.letter_content;
                openModal(document.getElementById('letter-download-modal'));
                clearLetterForm();
                fetchLetters();
            } catch (error) {
                showCustomAlert(`خطا در تولید نامه: ${error.message}`);
            }
        };

        const clearLetterForm = () => {
            document.getElementById('subject').value = '';
            document.getElementById('body').value = '';
            document.getElementById('org-select').value = '';
            document.getElementById('contact-select').value = '';
            document.getElementById('selected-org-id').value = '';
            document.getElementById('selected-contact-id').value = '';
        };

        const fetchUsers = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/users?company_name=${encodeURIComponent(currentUser.company_name)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                populateUsersTable(await response.json());
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری کاربران: ${error.message}`);
            }
        };

        const populateUsersTable = (users) => {
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';
            if (users.length === 0) {
                usersTableBody.innerHTML = `<tr><td colspan="3" class="py-3 px-6 text-center text-gray-500">هیچ کاربری یافت نشد.</td></tr>`;
                return;
            }
            users.forEach(user => {
                const row = usersTableBody.insertRow();
                const canEdit = currentUser.role === 'admin' || currentUser.role === 'superadmin';
                row.innerHTML = `
                    <td class="py-4 px-6">${user.email}</td>
                    <td class="py-4 px-6">${user.role}</td>
                    <td class="py-4 px-6 text-center">
                        <button class="text-blue-600 hover:text-blue-800 font-medium ml-2" onclick="openEditUserModal(${user.id})" ${canEdit ? '' : 'disabled'}>ویرایش</button>
                        <button class="text-red-600 hover:text-red-800 font-medium" onclick="deleteUser(${user.id})" ${canEdit ? '' : 'disabled'}>حذف</button>
                    </td>
                `;
            });
        };

        const addUser = async (userData) => {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...userData, company_name: currentUser.company_name }),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                showCustomAlert('کاربر با موفقیت افزوده شد.');
                fetchUsers();
                return true;
            } catch (error) {
                showCustomAlert(`خطا در افزودن کاربر: ${error.message}`);
                return false;
            }
        };

        window.openEditUserModal = async (userId) => {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}?company_name=${encodeURIComponent(currentUser.company_name)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const user = await response.json();
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-role').value = user.role;
                openModal(document.getElementById('editUserModal'));
            } catch (error) {
                showCustomAlert(`خطا در بارگذاری اطلاعات کاربر: ${error.message}`);
            }
        };

        const editUser = async (userData) => {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...userData, company_name: currentUser.company_name }),
                });
                if (!response.ok) throw new Error((await response.json()).message);
                showCustomAlert('کاربر با موفقیت ویرایش شد.');
                fetchUsers();
                return true;
            } catch (error) {
                showCustomAlert(`خطا در ویرایش کاربر: ${error.message}`);
                return false;
            }
        };

        window.deleteUser = (userId) => {
            showCustomConfirm('آیا مطمئن هستید که می‌خواهید این کاربر را حذف کنید؟', async (confirmed) => {
                if (confirmed) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${userId}?company_name=${encodeURIComponent(currentUser.company_name)}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) throw new Error((await response.json()).message);
                        showCustomAlert('کاربر با موفقیت حذف شد.');
                        fetchUsers();
                    } catch (error) {
                        showCustomAlert(`خطا در حذف کاربر: ${error.message}`);
                    }
                }
            });
        };

        document.addEventListener('DOMContentLoaded', async () => {
            showStatus('برنامه در حال بارگذاری است...');
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    await fetchCompanySettings();
                    if (currentUser.company_name) {
                        showStatus(`خوش آمدید، ${currentUser.email}`);
                        document.getElementById('sidebar-user-email').textContent = currentUser.email;
                        document.getElementById('sidebar-company-name').textContent = currentUser.company_name;
                        applyUserPermissions();
                        activateTab('dashboard');
                    } else {
                        window.location.href = '/';
                    }
                } catch (e) {
                    window.location.href = '/';
                }
            } else {
                window.location.href = '/';
            }

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    activateTab(link.dataset.tab);
                });
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = '/';
            });

            // Setup all modals and their close/cancel buttons
            document.querySelectorAll('.modal').forEach(modal => {
                modal.querySelector('.close-button')?.addEventListener('click', () => closeModal(modal));
                modal.querySelectorAll('button[type="button"]').forEach(btn => btn.addEventListener('click', () => closeModal(modal)));
            });

            // Form Submissions
            document.getElementById('add-org-form').addEventListener('submit', async e => {
                e.preventDefault();
                const success = await addOrganization({
                    name: document.getElementById('new-org-name').value,
                    industry: document.getElementById('new-org-industry').value,
                    phone: document.getElementById('new-org-phone').value,
                    email: document.getElementById('new-org-email').value,
                    address: document.getElementById('new-org-address').value,
                    description: document.getElementById('new-org-description').value,
                });
                if(success) closeModal(document.getElementById('addOrgModal'));
            });

            document.getElementById('edit-org-form').addEventListener('submit', async e => {
                e.preventDefault();
                const success = await editOrganization({
                    id: document.getElementById('edit-org-id').value,
                    name: document.getElementById('edit-org-name').value,
                    industry: document.getElementById('edit-org-industry').value,
                    phone: document.getElementById('edit-org-phone').value,
                    email: document.getElementById('edit-org-email').value,
                    address: document.getElementById('edit-org-address').value,
                    description: document.getElementById('edit-org-description').value,
                });
                if(success) closeModal(document.getElementById('editOrgModal'));
            });

            document.getElementById('add-contact-form').addEventListener('submit', async e => {
                e.preventDefault();
                const success = await addContact({
                    first_name: document.getElementById('new-contact-first-name').value,
                    last_name: document.getElementById('new-contact-last-name').value,
                    title: document.getElementById('new-contact-title').value,
                    organization_id: document.getElementById('new-contact-org-id').value,
                    phone: document.getElementById('new-contact-phone').value,
                    email: document.getElementById('new-contact-email').value,
                    notes: document.getElementById('new-contact-notes').value,
                });
                if(success) closeModal(document.getElementById('addContactModal'));
            });

            document.getElementById('edit-contact-form').addEventListener('submit', async e => {
                e.preventDefault();
                const success = await editContact({
                    id: document.getElementById('edit-contact-id').value,
                    first_name: document.getElementById('edit-contact-first-name').value,
                    last_name: document.getElementById('edit-contact-last-name').value,
                    title: document.getElementById('edit-contact-title').value,
                    organization_id: document.getElementById('edit-contact-org-id').value,
                    phone: document.getElementById('edit-contact-phone').value,
                    email: document.getElementById('edit-contact-email').value,
                    notes: document.getElementById('edit-contact-notes').value,
                });
                if(success) closeModal(document.getElementById('editContactModal'));
            });

            document.getElementById('add-user-form').addEventListener('submit', async e => {
                e.preventDefault();
                if (document.getElementById('new-user-password').value !== document.getElementById('new-user-confirm-password').value) {
                    showCustomAlert('رمز عبور و تایید آن یکسان نیستند.');
                    return;
                }
                const success = await addUser({
                    email: document.getElementById('new-user-email').value,
                    password: document.getElementById('new-user-password').value,
                    role: document.getElementById('new-user-role').value,
                });
                if(success) closeModal(document.getElementById('addUserModal'));
            });

            document.getElementById('edit-user-form').addEventListener('submit', async e => {
                e.preventDefault();
                const success = await editUser({
                    id: document.getElementById('edit-user-id').value,
                    role: document.getElementById('edit-user-role').value,
                });
                if(success) closeModal(document.getElementById('editUserModal'));
            });

            // Button clicks
            document.getElementById('add-org-btn').addEventListener('click', () => openModal(document.getElementById('addOrgModal')));
            document.getElementById('edit-org-btn').addEventListener('click', openEditOrganizationModal);
            document.getElementById('delete-org-btn').addEventListener('click', deleteOrganization);
            document.getElementById('add-contact-btn').addEventListener('click', () => { fetchOrganizations(); openModal(document.getElementById('addContactModal')); });
            document.getElementById('edit-contact-btn').addEventListener('click', openEditContactModal);
            document.getElementById('delete-contact-btn').addEventListener('click', deleteContact);
            document.getElementById('manage-users-btn').addEventListener('click', () => {
                const section = document.getElementById('manage-users-section');
                section.classList.toggle('hidden');
                if(!section.classList.contains('hidden')) fetchUsers();
            });
            document.getElementById('add-user-btn').addEventListener('click', () => {
                document.getElementById('new-user-company-name').value = currentUser.company_name;
                openModal(document.getElementById('addUserModal'));
            });
            document.getElementById('select-org-btn').addEventListener('click', () => openOrgSelectionDialog());
            document.getElementById('select-contact-btn').addEventListener('click', () => openContactSelectionDialog());
            document.getElementById('generate-letter-btn').addEventListener('click', generateLetter);
            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const updatedSettings = {
                    company_name: currentUser.company_name,
                    company_short_name: document.getElementById('company-short-name').value.trim(),
                    company_full_name_footer: document.getElementById('company-full-name-footer').value.trim(),
                };
                try {
                    const response = await fetch(`${API_BASE_URL}/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedSettings),
                    });
                    if (!response.ok) throw new Error((await response.json()).message);
                    showCustomAlert('تنظیمات با موفقیت ذخیره شد.');
                    await fetchCompanySettings();
                } catch (error) {
                    showCustomAlert(`خطا در ذخیره تنظیمات: ${error.message}`);
                }
            });
            document.getElementById('upload-template-btn').addEventListener('click', async () => {
                const fileInput = document.getElementById('template-upload-input');
                if (fileInput.files.length === 0) {
                    showCustomAlert('لطفاً ابتدا یک فایل انتخاب کنید.');
                    return;
                }
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('letter_template', file);
                formData.append('company_name', currentUser.company_name);
                try {
                    const response = await fetch(`${API_BASE_URL}/settings/upload_template`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) throw new Error((await response.json()).message);
                    const result = await response.json();
                    currentUser.letter_template_path = result.template_full_path;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('current-template-filename-display').textContent = result.template_filename;
                    document.getElementById('template-preview-container').style.display = 'block';
                    showCustomAlert(`فایل "${result.template_filename}" با موفقیت آپلود شد.`);
                } catch (error) {
                    showCustomAlert(`خطا در آپلود فایل: ${error.message}`);
                }
            });
            document.getElementById('template-upload-input').addEventListener('change', (e) => {
                document.getElementById('template-file-name').textContent = e.target.files.length > 0 ? e.target.files[0].name : 'فایلی انتخاب نشده است.';
            });
            document.getElementById('download-docx-btn').addEventListener('click', () => {
                if(currentGeneratedLetterDownloadUrl) window.open(currentGeneratedLetterDownloadUrl, '_blank');
            });
            document.getElementById('copy-letter-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('letter-body-display').textContent).then(() => showCustomAlert('متن نامه کپی شد!'), () => showCustomAlert('خطا در کپی کردن متن.'));
            });
            document.getElementById('download-pdf-btn').addEventListener('click', () => {
                const element = document.getElementById('modal-letter-content');
                const opt = { margin: 1, filename: `${currentGeneratedLetterCode}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
                html2pdf().from(element).set(opt).save();
            });
        });
    </script>
</body>
</html>

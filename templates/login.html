<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به سیستم CRM</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .login-container {
            background-color: #ffffff;
            padding: 2.5rem; /* p-10 */
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            width: 100%;
            max-width: 400px; /* max-w-md */
        }
        input[type="text"],
        input[type="email"], /* Added email type */
        input[type="password"] {
            @apply shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline;
        }
        button {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md w-full focus:outline-none focus:shadow-outline transition duration-200;
        }
        .error-message {
            @apply text-red-500 text-sm mt-2;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">ورود به سیستم</h2>
        <form id="login-form" class="space-y-6">
            <div>
                <label for="company-name-login" class="block text-gray-700 text-sm font-bold mb-2">نام شرکت:</label>
                <input type="text" id="company-name-login" placeholder="نام شرکت" required>
            </div>
            <div>
                <label for="email-login" class="block text-gray-700 text-sm font-bold mb-2">ایمیل:</label>
                <input type="email" id="email-login" placeholder="ایمیل" required>
            </div>
            <div>
                <label for="password-login" class="block text-gray-700 text-sm font-bold mb-2">رمز عبور:</label>
                <input type="password" id="password-login" placeholder="رمز عبور" required>
            </div>
            <button type="submit">ورود</button>
        </form>
        <p id="login-message" class="error-message text-center"></p>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api'; // Base URL for your Flask API

        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const companyNameInput = document.getElementById('company-name-login');
            const emailInput = document.getElementById('email-login'); // Changed from username to email
            const passwordInput = document.getElementById('password-login');
            const loginMessage = document.getElementById('login-message');

            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const companyName = companyNameInput.value.trim();
                const email = emailInput.value.trim(); // Changed from username to email
                const password = passwordInput.value.trim();

                loginMessage.textContent = 'در حال ورود...';
                loginMessage.classList.remove('text-red-500');
                loginMessage.classList.add('text-gray-600');

                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ company_name: companyName, email: email, password: password }), // Changed username to email
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Store user info in localStorage (or sessionStorage)
                        localStorage.setItem('currentUser', JSON.stringify({
                            id: data.user_id,
                            role: data.role,
                            company_name: data.company_name,
                            email: data.user_email // Store email
                        }));
                        loginMessage.textContent = 'ورود موفقیت‌آمیز! در حال انتقال...';
                        loginMessage.classList.remove('text-red-500');
                        loginMessage.classList.add('text-green-600');
                        
                        // Redirect based on user role
                        if (data.role === 'superadmin') {
                            window.location.href = '/superadmin_dashboard'; 
                        } else {
                            window.location.href = '/main_app'; 
                        }
                    } else {
                        loginMessage.textContent = data.message || 'خطا در ورود به سیستم.';
                        loginMessage.classList.remove('text-gray-600');
                        loginMessage.classList.add('text-red-500');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    loginMessage.textContent = 'خطا در ارتباط با سرور.';
                    loginMessage.classList.remove('text-gray-600');
                    loginMessage.classList.add('text-red-500');
                }
            });
        });
    </script>
</body>
</html>